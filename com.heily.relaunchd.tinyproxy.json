/*
  #
  # Copyright (c) 2016 Mark Heily <mark@heily.com>
  #
  # Permission to use, copy, modify, and distribute this software for any
  # purpose with or without fee is hereby granted, provided that the above
  # copyright notice and this permission notice appear in all copies.
  # 
  # THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
  # WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
  # MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
  # ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
  # WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
  # ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
  # OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
  #
  
  # Setup tinyproxy on FreeBSD to provide outbound HTTP service to jails
  # The Squid proxy uses port 3128, so we use that here.
  #
*/
Label = "com.heily.relaunchd.tinyproxy";
ProgramArguments = [ "/usr/local/sbin/tinyproxy", "-d" ];
RunAtLoad = true;
KeepAlive = true;
UserName = "root";
GroupName = "wheel";
Packages = ["tinyproxy"];
PostInstallScript = <<EOF
  cp /usr/local/etc/tinyproxy.conf.sample /usr/local/etc/tinyproxy.conf
  ifconfig lo1 | grep 127.89.0.1 || ifconfig lo1 127.89.0.1 alias
  sed -i -e '
  	s/^#Listen .*/Listen 127.89.0.1/;
  	s/^#Syslog On/Syslog On/;
  	s/^#PidFile .*/PidFile "\/var\/run\/tinyproxy.pid"/;
  	s/^Port 8888/Port 3128/;
  	s/^Allow 127.0.0.1/Allow 127.89.0.0\/16/;
  ' /usr/local/etc/tinyproxy.conf
EOF
